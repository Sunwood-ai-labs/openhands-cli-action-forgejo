name: Claude Code (Working on Forgejo)

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request:
    types: [opened, synchronize]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude'))) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, '@claude'))
    runs-on: docker
    container:
      image: ubuntu:latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    
    env:
      DEBIAN_FRONTEND: noninteractive
      TZ: Asia/Tokyo
    
    steps:
      - name: Install dependencies
        run: |
          echo 'tzdata tzdata/Areas select Asia' | debconf-set-selections
          echo 'tzdata tzdata/Zones/Asia select Tokyo' | debconf-set-selections
          ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
          echo 'Asia/Tokyo' > /etc/timezone
          
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata git curl unzip wget ca-certificates jq
          
          # Node.js 20ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          DEBIAN_FRONTEND=noninteractive apt-get install -y nodejs
          
          # Bun ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          curl -fsSL https://bun.sh/install | bash
          export PATH="$HOME/.bun/bin:$PATH"
          echo "PATH=$HOME/.bun/bin:$PATH" >> $GITHUB_ENV
          
          echo "âœ… Dependencies installed successfully"
          node --version
          npm --version
          bun --version

      - name: Add eyes reaction to indicate processing started
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CLAUDE_BOT_TOKEN || secrets.GITHUB_TOKEN }}  # ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³å„ªå…ˆ
          script: |
            console.log('ğŸ‘€ Adding eyes reaction to indicate processing started...');
            
            try {
              if (context.eventName === 'issue_comment') {
                // ã‚³ãƒ¡ãƒ³ãƒˆã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
                await github.rest.reactions.createForIssueComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: context.payload.comment.id,
                  content: 'eyes'
                });
                console.log('âœ… Added eyes reaction to comment');
              } else if (context.eventName === 'issues') {
                // ã‚¤ã‚·ãƒ¥ãƒ¼ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
                await github.rest.reactions.createForIssue({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  content: 'eyes'
                });
                console.log('âœ… Added eyes reaction to issue');
              } else if (context.eventName === 'pull_request') {
                // ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
                await github.rest.reactions.createForIssue({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  content: 'eyes'
                });
                console.log('âœ… Added eyes reaction to pull request');
              }
            } catch (error) {
              console.log('âš ï¸ Failed to add reaction:', error.message);
              // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ã«å¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ç¶šè¡Œ
            }

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract prompt from event
        id: extract_prompt
        run: |
          echo "ğŸ” Extracting prompt from GitHub event..."
          
          case "${{ github.event_name }}" in
            "issue_comment")
              PROMPT_TEXT="${{ github.event.comment.body }}"
              ISSUE_NUMBER="${{ github.event.issue.number }}"
              ;;
            "issues")
              PROMPT_TEXT="${{ github.event.issue.body }}"
              ISSUE_NUMBER="${{ github.event.issue.number }}"
              ;;
            "pull_request")
              PROMPT_TEXT="${{ github.event.pull_request.body }}"
              ISSUE_NUMBER="${{ github.event.pull_request.number }}"
              ;;
          esac
          
          # @claudeã‚’é™¤å»ã—ã¦å®Ÿéš›ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŠ½å‡º
          CLEAN_PROMPT=$(echo "$PROMPT_TEXT" | sed 's/@claude//g' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
          
          # ç©ºã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
          if [ -z "$CLEAN_PROMPT" ]; then
            CLEAN_PROMPT="ã“ã‚“ã«ã¡ã¯ï¼ã©ã®ã‚ˆã†ãªãŠæ‰‹ä¼ã„ã‚’ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦åˆ†æã—ã¦ã€ææ¡ˆã‚’ãŠèã‹ã›ãã ã•ã„ã€‚"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          mkdir -p /tmp/claude-prompts
          echo "$CLEAN_PROMPT" > /tmp/claude-prompts/prompt.txt
          
          echo "ğŸ“ Extracted prompt:"
          echo "$CLEAN_PROMPT"
          echo "prompt_file=/tmp/claude-prompts/prompt.txt" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

      - name: Run Claude Code Base Action
        id: claude
        uses: anthropics/claude-code-base-action@main
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt_file: ${{ steps.extract_prompt.outputs.prompt_file }}
          allowed_tools: "Bash(bun install),Bash(bun test),Bash(bun run format),Bash(bun typecheck),Edit,Replace,View,GlobTool,GrepTool,Write"
          model: "claude-sonnet-4-20250514"
          timeout_minutes: 30

      - name: Create Pull Request if changes were made
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CLAUDE_BOT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const { execSync } = require('child_process');
            const fs = require('fs');
            
            // Claude ã®çµæœã‚’å–å¾—
            let claudeResult = "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ";
            const filePath = '/tmp/claude-execution-output.json';
            
            if (fs.existsSync(filePath)) {
              try {
                const data = JSON.parse(fs.readFileSync(filePath, 'utf8'));
                if (Array.isArray(data)) {
                  const resultItem = data.find(item => item.type === 'result');
                  if (resultItem && resultItem.result) {
                    claudeResult = resultItem.result;
                  }
                }
              } catch (e) {
                console.log('Could not read Claude result, using default');
              }
            }
            
            try {
              // Gitè¨­å®š
              execSync('git config --global user.name "Claude Assistant"');
              execSync('git config --global user.email "claude-assistant@anthropic.com"');
              
              // å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              const hasChanges = execSync('git status --porcelain', { encoding: 'utf8' }).trim();
              
              if (!hasChanges) {
                console.log('ğŸ“ No changes detected, posting result without PR');
                
                // å¤‰æ›´ãŒãªã„å ´åˆã¯é€šå¸¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
                const issueNumber = ${{ steps.extract_prompt.outputs.issue_number }};
                await github.rest.issues.createComment({
                  issue_number: issueNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `## ğŸ¤– Claude Bot ã‹ã‚‰ã®å›ç­”\n\n${claudeResult}\n\n---\n*ğŸ¤– Claude Assistant | å®Ÿè¡Œæ™‚é–“: ${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}*`
                });
                return;
              }
              
              console.log('ğŸ“‹ Changes detected:');
              console.log(hasChanges);
              
              // ãƒ–ãƒ©ãƒ³ãƒåã‚’ç”Ÿæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãï¼‰
              const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
              const branchName = `claude/auto-update-${timestamp}`;
              
              console.log(`ğŸŒ¿ Creating branch: ${branchName}`);
              
              // æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¦ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              execSync(`git checkout -b ${branchName}`);
              
              // å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
              execSync('git add .');
              
              // ã‚³ãƒŸãƒƒãƒˆï¼ˆClaudeã®å›ç­”ã‚’ä½¿ç”¨ï¼‰
              const commitMessage = `ğŸ¤– Claude Assistant: ${claudeResult}`;
              
              execSync(`git commit -m "${commitMessage}"`);
              console.log('ğŸ“¦ Changes committed');
              
              // ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
              execSync(`git push origin ${branchName}`);
              console.log('ğŸš€ Branch pushed to remote');
              
              // ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ¤– Claude Assistant ã«ã‚ˆã‚‹è‡ªå‹•æ›´æ–°`,
                head: branchName,
                base: 'main',
                body: `## ğŸ¤– Claude Assistant ã«ã‚ˆã‚‹è‡ªå‹•æ›´æ–°\n\n${claudeResult}\n\n### å¤‰æ›´å†…å®¹\n\`\`\`\n${hasChanges}\n\`\`\`\n\n---\n*ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ Claude Assistant ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`
              });
              
              console.log(`âœ… Pull Request created: #${pr.number}`);
              console.log(`ğŸ“ URL: ${pr.html_url}`);
              
              // å…ƒã®ã‚¤ã‚·ãƒ¥ãƒ¼/ã‚³ãƒ¡ãƒ³ãƒˆã«ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¸ã®ãƒªãƒ³ã‚¯ã‚’æŠ•ç¨¿
              const issueNumber = ${{ steps.extract_prompt.outputs.issue_number }};
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ğŸ‰ **å¤‰æ›´å®Œäº†ï¼**\n\n${claudeResult}\n\n**ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ:** #${pr.number}\n\nğŸ‘‰ [ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèªã™ã‚‹](${pr.html_url})\n\n---\n*ğŸ¤– Claude Assistant | å®Ÿè¡Œæ™‚é–“: ${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}*`
              });
              
            } catch (error) {
              console.error('âŒ Error creating pull request:', error.message);
              
              // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯é€šå¸¸ã®å›ç­”ã‚’æŠ•ç¨¿
              const response = `${claudeResult}\n\nâš ï¸ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è‡ªå‹•ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
              
              const issueNumber = ${{ steps.extract_prompt.outputs.issue_number }};
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ¤– Claude Bot ã‹ã‚‰ã®å›ç­”\n\n${response}\n\n---\n*ğŸ¤– Claude Assistant | å®Ÿè¡Œæ™‚é–“: ${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}*`
              });
            }

      - name: Add completion reaction
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CLAUDE_BOT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            let status = "${{ steps.claude.outcome }}";
            let reactionContent = status === 'success' ? '+1' : '-1';
            
            // å®Œäº†ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            try {
              if (context.eventName === 'issue_comment') {
                await github.rest.reactions.createForIssueComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: context.payload.comment.id,
                  content: reactionContent
                });
              } else if (context.eventName === 'issues') {
                await github.rest.reactions.createForIssue({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  content: reactionContent
                });
              } else if (context.eventName === 'pull_request') {
                await github.rest.reactions.createForIssue({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  content: reactionContent
                });
              }
              console.log(`âœ… Added ${reactionContent} reaction for completion`);
            } catch (error) {
              console.log('âš ï¸ Failed to add completion reaction:', error.message);
            }
